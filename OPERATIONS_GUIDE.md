# 📋 Omniy 運用・保守統合ガイド

> **プロジェクト**: Omniy Instagram予約投稿アプリ  
> **バージョン**: 1.0  
> **最終更新**: 2025-01-09  
> **ステータス**: 承認済み

---

## 📋 **運用概要**

本文書は、Omniy の本番運用に関する SLA、監視体制、障害対応手順、バックアップ・復旧計画を定義します。1人運営を前提とした効率的で自動化された運用体制を構築し、99.9%の稼働率を実現します。

### **運用基本方針**
- **自動化最優先**: 手動運用を最小限に抑制
- **予防的監視**: 障害を未然に防ぐ仕組み
- **迅速な復旧**: 1時間以内の復旧体制
- **透明性**: ユーザーへの適切な情報提供
- **継続改善**: 運用効率の定期的見直し

---

## 📊 **SLA (Service Level Agreement)**

### **稼働率保証**

#### **サービスレベル定義**
```yaml
システム全体稼働率:
  - 目標: 99.9% (月間ダウンタイム43分以内)
  - 測定期間: 月次
  - 測定方法: 外部監視ツール (UptimeRobot)
  
コアAPI稼働率:
  - 目標: 99.95% (月間ダウンタイム22分以内)
  - 除外条件: 計画停止、DDoS攻撃
  
投稿実行成功率:
  - 目標: 99.5% (失敗率0.5%以内)
  - 測定対象: スケジュール通りの投稿実行
  - リトライ含む最終成功率
```

#### **応答時間保証**
```yaml
Webページ表示:
  - 目標: 3秒以内 (95%ile)
  - 測定方法: Real User Monitoring

API応答時間:
  - 目標: 500ms以内 (95%ile)
  - 対象: 認証、データ取得API
  
画像アップロード:
  - 目標: 10秒以内 (10MB以下)
  - 条件: 安定したネットワーク環境
```

### **補償規定**
```yaml
稼働率未達時のサービスクレジット:
  - 99.9% → 99.0%: 月額料金の10%
  - 99.0% → 95.0%: 月額料金の25%
  - 95.0%未満: 月額料金の50%

適用条件:
  - ユーザーからの申請必須
  - 申請期限: 翌月末まで
  - 計画停止は除外
```

---

## 📊 **監視・アラート体制**

### **監視アーキテクチャ**

#### **監視レイヤー**
```yaml
インフラ監視:
  - ツール: Google Cloud Monitoring
  - 対象: CPU、メモリ、ディスク、ネットワーク
  - 頻度: 1分間隔

アプリケーション監視:
  - ツール: Firebase Performance Monitoring
  - 対象: API応答時間、エラー率、スループット
  - 頻度: リアルタイム

外部監視:
  - ツール: UptimeRobot
  - 対象: Webサイト、API エンドポイント
  - 頻度: 5分間隔

ビジネス監視:
  - ツール: カスタムダッシュボード
  - 対象: 投稿成功率、ユーザー登録数、売上
  - 頻度: 10分間隔
```

### **アラート設定**

#### **クリティカルアラート（即座対応）**
```yaml
サービス停止:
  - 条件: HTTP 5xx エラー率 > 10%
  - 通知: Slack + SMS + Email
  - 対応時間: 15分以内

決済システム障害:
  - 条件: Stripe Webhook 失敗率 > 5%
  - 通知: Slack + SMS + Email
  - 対応時間: 10分以内

データベース接続異常:
  - 条件: Firestore 接続失敗率 > 3%
  - 通知: Slack + SMS
  - 対応時間: 20分以内

投稿実行大量失敗:
  - 条件: 投稿失敗率 > 20% (15分間)
  - 通知: Slack + Email
  - 対応時間: 30分以内
```

#### **警告アラート（1時間以内対応）**
```yaml
パフォーマンス劣化:
  - 条件: API応答時間 > 2秒 (15分間)
  - 通知: Slack

リソース使用率高:
  - 条件: CPU使用率 > 80% (30分間)
  - 通知: Slack

ストレージ容量警告:
  - 条件: 使用率 > 85%
  - 通知: Email

認証エラー増加:
  - 条件: 認証失敗率 > 15% (30分間)
  - 通知: Slack
```

#### **情報アラート（24時間以内対応）**
```yaml
ユーザー行動異常:
  - 条件: DAU 20%以上減少
  - 通知: Email

外部API制限接近:
  - 条件: Instagram API使用率 > 80%
  - 通知: Email

セキュリティイベント:
  - 条件: 異常ログイン検知
  - 通知: Slack + Email
```

### **監視ダッシュボード**

#### **運用ダッシュボード構成**
```yaml
システム概要:
  - サービス稼働状況
  - リアルタイムユーザー数
  - API応答時間
  - エラー発生状況

インフラ状況:
  - Cloud Functions実行回数
  - Firestore 読み書き回数
  - Storage使用量
  - CDN転送量

ビジネス指標:
  - 新規登録数 (日次)
  - アクティブユーザー数
  - 投稿実行数・成功率
  - 売上・MRR推移

ユーザー体験:
  - ページロード時間
  - エラー発生率
  - 機能利用状況
  - サポート問い合わせ数
```

---

## 🚨 **障害対応手順**

### **障害分類・優先度**

#### **Severity 1 (クリティカル)**
```yaml
定義:
  - サービス全停止
  - 決済システム障害
  - データ損失・漏洩
  - セキュリティ侵害

対応目標:
  - 初期対応: 15分以内
  - 復旧時間: 1時間以内
  - 完全解決: 4時間以内

エスカレーション:
  - 即座にオンコール担当者へ
  - 30分で解決しない場合は外部専門家へ
```

#### **Severity 2 (高)**
```yaml
定義:
  - コア機能の部分停止
  - パフォーマンス大幅劣化
  - 投稿実行大量失敗

対応目標:
  - 初期対応: 30分以内
  - 復旧時間: 4時間以内
  - 完全解決: 24時間以内
```

#### **Severity 3 (中)**
```yaml
定義:
  - 軽微な機能障害
  - 一部ユーザーへの影響
  - UI表示問題

対応目標:
  - 初期対応: 2時間以内
  - 復旧時間: 8時間以内
  - 完全解決: 72時間以内
```

### **初期対応手順**

#### **1. 障害検知・確認**
```bash
# 1. システム状況確認
echo "=== システム状況確認 ==="
curl -I https://omniy.app/health
firebase deploy --only functions:healthCheck

# 2. 監視ダッシュボード確認
echo "Cloud Monitoring ダッシュボード確認"
echo "Firebase Console エラーログ確認"

# 3. 外部監視確認
echo "UptimeRobot ステータス確認"
echo "ユーザー報告 (SNS, メール) 確認"
```

#### **2. 影響範囲調査**
```bash
# ユーザー影響調査
echo "=== 影響範囲調査 ==="

# アクティブユーザー数確認
firebase analytics:events

# エラー発生率確認
gcloud logging read "resource.type=cloud_function" \
  --format="csv(timestamp,severity)" \
  --filter="timestamp>='-PT1H'"

# 投稿実行状況確認
echo "投稿スケジュール実行ログ確認"
```

#### **3. 緊急回避・復旧**
```bash
# 緊急回避手順
echo "=== 緊急回避手順 ==="

# 1. 問題のある機能を一時停止
# Feature Flag で機能無効化
firebase deploy --only hosting:disable-feature

# 2. 前回正常版へロールバック
gcloud app versions migrate PREVIOUS_VERSION

# 3. トラフィック制限
echo "必要に応じてレート制限強化"

# 4. ユーザー通知
echo "ステータスページ更新"
echo "SNS・メール通知送信"
```

### **根本原因分析 (RCA)**

#### **RCA テンプレート**
```yaml
インシデント概要:
  - 発生日時: YYYY-MM-DD HH:MM
  - 検知日時: YYYY-MM-DD HH:MM
  - 復旧日時: YYYY-MM-DD HH:MM
  - 影響範囲: ユーザー数、機能
  - Severity: 1-4

タイムライン:
  - HH:MM: 障害発生
  - HH:MM: 検知・対応開始
  - HH:MM: 緊急回避実施
  - HH:MM: 根本修正実施
  - HH:MM: 完全復旧確認

根本原因:
  - 技術的原因: 
  - プロセス上の原因:
  - 人的要因:

影響評価:
  - 機能停止時間:
  - 影響ユーザー数:
  - ビジネス損失:
  - SLA違反:

対策:
  - 即座対策 (実施済み):
  - 恒久対策 (実施予定):
  - 予防策:
  - プロセス改善:

学んだ教訓:
  - 検知改善:
  - 対応改善:
  - 設計改善:
```

---

## 💾 **バックアップ・復旧**

### **バックアップ戦略**

#### **データバックアップ**
```yaml
Firestore データベース:
  - 方式: 自動エクスポート
  - 頻度: 日次 (3:00 AM JST)
  - 保存期間: 30日間
  - 保存場所: Cloud Storage (別リージョン)
  
Cloud Storage ファイル:
  - 方式: 自動レプリケーション
  - 頻度: リアルタイム
  - 保存期間: 90日間 (アーカイブ含む)
  - 保存場所: マルチリージョン

アプリケーションコード:
  - 方式: Git リポジトリ
  - 頻度: プッシュ毎
  - 保存期間: 無期限
  - 保存場所: GitHub (プライベート)

設定・シークレット:
  - 方式: 暗号化バックアップ
  - 頻度: 変更時
  - 保存期間: 6ヶ月
  - 保存場所: セキュアストレージ
```

#### **バックアップ自動化**
```bash
#!/bin/bash
# 日次バックアップスクリプト

echo "=== 日次バックアップ開始 ==="

# 1. Firestore エクスポート
gcloud firestore export gs://omniy-backup-bucket/$(date +%Y%m%d) \
  --project omniy-prod

# 2. 設定バックアップ
firebase functions:config:get > config-backup-$(date +%Y%m%d).json

# 3. バックアップ検証
echo "バックアップファイル確認中..."
gsutil ls gs://omniy-backup-bucket/$(date +%Y%m%d)/

# 4. 古いバックアップ削除 (30日以上)
gsutil -m rm -r gs://omniy-backup-bucket/$(date -d '30 days ago' +%Y%m%d)/ 2>/dev/null

echo "=== 日次バックアップ完了 ==="
```

### **災害復旧計画 (DRP)**

#### **復旧手順書**

**Level 1: 部分障害復旧**
```bash
# 1. 影響範囲特定
echo "=== 部分障害復旧手順 ==="

# 問題コンポーネント特定
firebase functions:log --only function-name

# 2. 問題機能の無効化
firebase deploy --only functions:disableFunction

# 3. 正常機能の動作確認
curl -f https://omniy.app/api/health

# 4. 問題修正・再デプロイ
firebase deploy --only functions:fixedFunction
```

**Level 2: システム全体復旧**
```bash
# 1. 緊急時静的ページ表示
echo "=== システム全体復旧手順 ==="

# メンテナンスページ表示
firebase hosting:disable
gsutil cp maintenance.html gs://omniy-static-bucket/index.html

# 2. 最新正常版へロールバック
gcloud app versions migrate LAST_KNOWN_GOOD_VERSION

# 3. データ整合性確認
# Firestore 整合性チェック
# ユーザーデータ確認

# 4. 段階的復旧
# 認証機能 → コア機能 → 全機能
```

**Level 3: 完全災害復旧**
```bash
# 1. 新環境構築
echo "=== 完全災害復旧手順 ==="

# Firebase プロジェクト新規作成
firebase projects:create omniy-recovery

# 2. バックアップからデータ復元
gcloud firestore import gs://omniy-backup-bucket/LATEST/ \
  --project omniy-recovery

# 3. アプリケーション復旧
git clone https://github.com/omniy/omniy-app.git
cd omniy-app
firebase use omniy-recovery
firebase deploy

# 4. DNS 切り替え
# omniy.app → 新環境
# TTL短縮済みのため即座反映

# 5. 動作確認・ユーザー通知
```

### **復旧時間目標 (RTO/RPO)**

```yaml
RTO (Recovery Time Objective):
  - Level 1 (部分障害): 30分以内
  - Level 2 (システム障害): 2時間以内
  - Level 3 (完全災害): 8時間以内

RPO (Recovery Point Objective):
  - Firestore データ: 24時間以内
  - Cloud Storage: 1時間以内
  - アプリケーションコード: 0分 (Git)
  - 設定情報: 24時間以内

データ損失許容範囲:
  - ユーザーデータ: 0件
  - 投稿スケジュール: 24時間分
  - ログデータ: 1時間分
  - 分析データ: 1日分
```

---

## 📊 **定期メンテナンス**

### **日次作業**

#### **自動化スケジュール**
```yaml
03:00 JST - 日次バックアップ:
  - Firestore エクスポート
  - 設定ファイルバックアップ
  - バックアップ検証
  
04:00 JST - ログ整理:
  - 古いログファイル削除
  - ログ圧縮・アーカイブ
  - ディスク使用量確認

05:00 JST - セキュリティスキャン:
  - 依存関係脆弱性チェック
  - 不正アクセス試行検知
  - SSL証明書有効期限確認

06:00 JST - パフォーマンスレポート:
  - 前日のシステム性能分析
  - API応答時間トレンド
  - エラー発生状況まとめ
```

#### **手動確認項目**
```bash
# 日次ヘルスチェック (10分)
echo "=== 日次ヘルスチェック ==="

# 1. システム正常性確認
curl -f https://omniy.app/api/health
firebase functions:log --since 1d

# 2. ビジネス指標確認
echo "新規登録数: $(firebase analytics:events --event sign_up)"
echo "投稿実行数: $(firebase analytics:events --event post_executed)"

# 3. アラート状況確認
echo "過去24時間のアラート数確認"

# 4. ユーザーフィードバック確認
echo "サポート問い合わせ・レビュー確認"
```

### **週次作業**

```yaml
月曜日 - システムレビュー:
  - 週間パフォーマンスレポート作成
  - 障害・インシデント振り返り
  - 改善提案検討

水曜日 - セキュリティレビュー:
  - アクセスログ分析
  - 権限設定確認
  - 脆弱性対応状況

金曜日 - 容量・コストレビュー:
  - リソース使用量分析
  - コスト最適化検討
  - 容量増設計画
```

### **月次作業**

```yaml
月初 (1-5日) - 月次レポート:
  - SLA達成状況レポート
  - ビジネス指標分析
  - ユーザー満足度調査

月中 (15日) - 設定・権限見直し:
  - ユーザー権限監査
  - API キー・シークレット更新
  - バックアップ復旧テスト

月末 (25-30日) - 翌月計画:
  - 容量拡張計画
  - 機能追加・改善計画
  - 運用改善計画
```

---

## 📞 **サポート体制**

### **サポート方針**

```yaml
基本方針:
  - ユーザーファースト
  - 迅速な初期対応
  - 根本解決重視
  - プロアクティブサポート

対応品質:
  - 初回解決率: 80%以上
  - 顧客満足度: 4.5/5.0以上
  - 平均解決時間: 24時間以内
```

### **サポートチャネル**

#### **優先度別チャネル**
```yaml
緊急 (システム障害):
  - メール: emergency@omniy.app
  - 対応時間: 24時間365日
  - 初期応答: 1時間以内

高 (機能不具合):
  - メール: support@omniy.app
  - 対応時間: 平日9-18時
  - 初期応答: 4時間以内

中 (使い方質問):
  - メール: help@omniy.app
  - FAQ・ヘルプページ
  - 初期応答: 1営業日以内

低 (要望・提案):
  - フィードバックフォーム
  - ユーザーコミュニティ
  - 初期応答: 3営業日以内
```

### **エスカレーション手順**

```yaml
Level 1 - 初期対応:
  - FAQ・マニュアル参照
  - 基本的なトラブルシューティング
  - 既知問題の案内

Level 2 - 技術対応:
  - ログ調査・分析
  - 設定確認・調整
  - 一時的回避策提供

Level 3 - 開発対応:
  - コード調査・修正
  - 機能追加・改善
  - 根本的解決策実装
```

---

## 📈 **継続改善**

### **KPI監視**

#### **運用KPI**
```yaml
稼働率・パフォーマンス:
  - システム稼働率: 99.9%以上
  - API応答時間: 500ms以内
  - ページロード時間: 3秒以内

サポート品質:
  - 初回解決率: 80%以上
  - 平均解決時間: 24時間以内
  - 顧客満足度: 4.5/5.0以上

コスト効率:
  - インフラコスト/売上比: 10%以下
  - サポートコスト/売上比: 5%以下
  - 自動化率: 90%以上
```

### **改善プロセス**

#### **月次改善サイクル**
```yaml
Week 1 - データ収集:
  - KPI数値集計
  - インシデント分析
  - ユーザーフィードバック収集

Week 2 - 課題分析:
  - ボトルネック特定
  - 根本原因分析
  - 改善提案作成

Week 3 - 対策実装:
  - 優先度付け
  - 改善策実装
  - テスト・検証

Week 4 - 効果測定:
  - 改善効果測定
  - 次月計画策定
  - ナレッジ共有
```

---

## 🔗 **関連ドキュメント**

### **運用関連**
- `tools/docs/MONITORING_SETUP.md` - 詳細監視設定
- `tools/docs/INCIDENT_RESPONSE.md` - インシデント対応詳細
- `tools/docs/BACKUP_RESTORE.md` - バックアップ詳細手順

### **開発関連**
- `PROJECT_SPECIFICATIONS.md` - プロジェクト仕様
- `tools/docs/deployment-guide.md` - デプロイ手順
- `tools/docs/QA_STRATEGY.md` - 品質保証戦略

### **ユーザー関連**
- `tools/docs/USER_GUIDE.md` - ユーザーマニュアル
- `tools/docs/USER_FAQ.md` - よくある質問
- Status Page: https://status.omniy.app

---

**📝 更新履歴**
- 2025-01-09: 運用・保守統合ガイド作成
- 複数運用ドキュメントの統合・整理
- 1人運営特化の運用手順確立

> **💡 注意**: この文書は運用関連の複数ドキュメントを統合したマスタードキュメントです。今後はこの文書を中心に運用を行ってください。