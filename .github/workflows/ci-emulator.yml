name: ğŸ”¥ CI - Firestore Emulator Tests

on:
  push:
    branches: [ main, develop, feature/schedule-grid ]
  pull_request:
    branches: [ main, develop ]

jobs:
  frontend-tests:
    name: ğŸ§ª Frontend Tests (Emulator)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          functions/package-lock.json

    - name: â˜• Setup Java 11 (for Firebase Emulator)
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: ğŸ”§ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ“¦ Install functions dependencies
      working-directory: ./functions
      run: npm ci

    - name: ğŸ” Lint Frontend
      working-directory: ./frontend
      run: npm run lint:check

    - name: ğŸ” TypeScript Check
      working-directory: ./frontend
      run: npm run type-check

    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: npm run build

    - name: ğŸ”¥ Start Firebase Emulators
      run: |
        firebase emulators:start --only firestore,auth,functions &
        sleep 30
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/functions/.runtimeconfig.json

    - name: ğŸ§ª Run Frontend Unit Tests (Emulator)
      working-directory: ./frontend
      run: npm run test:emu
      env:
        VITE_FIRESTORE_EMULATE: true
        VITE_ENABLE_FIREBASE_EMULATOR: true

    - name: ğŸ“Š Generate Test Coverage
      working-directory: ./frontend
      run: npm run test:coverage
      env:
        VITE_FIRESTORE_EMULATE: true

    - name: ğŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        directory: ./frontend/coverage
        flags: frontend
        name: frontend-${{ matrix.node-version }}

  functions-tests:
    name: ğŸ”§ Functions Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json

    - name: â˜• Setup Java 11 (for Firebase Emulator)
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: ğŸ”§ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install functions dependencies
      working-directory: ./functions
      run: npm ci

    - name: ğŸ—ï¸ Build Functions
      working-directory: ./functions
      run: npm run build

    - name: ğŸ” Lint Functions
      working-directory: ./functions
      run: npm run lint

    - name: ğŸ§ª Run Functions Tests
      working-directory: ./functions
      run: npm run test

    - name: ğŸ“Š Generate Functions Coverage
      working-directory: ./functions
      run: npm run test:coverage

    - name: ğŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        directory: ./functions/coverage
        flags: functions
        name: functions

  e2e-tests:
    name: ğŸ­ E2E Tests (Cypress + Emulator)
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: â˜• Setup Java 11 (for Firebase Emulator)
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: ğŸ”§ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ“¦ Install functions dependencies
      working-directory: ./functions
      run: npm ci

    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: npm run build

    - name: ğŸ”¥ Start Firebase Emulators
      run: |
        firebase emulators:start --only firestore,auth,hosting,functions &
        sleep 45
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/functions/.runtimeconfig.json

    - name: ğŸ­ Run Cypress E2E Tests
      working-directory: ./frontend
      run: npm run test:e2e:headless
      env:
        CYPRESS_BASE_URL: http://localhost:5000
        VITE_FIRESTORE_EMULATE: true
        VITE_ENABLE_FIREBASE_EMULATOR: true

    - name: ğŸ“¦ Upload Cypress Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: cypress-screenshots-${{ matrix.node-version }}
        path: frontend/cypress/screenshots

    - name: ğŸ“¦ Upload Cypress Videos
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: cypress-videos-${{ matrix.node-version }}
        path: frontend/cypress/videos

  integration-tests:
    name: ğŸ”— Integration Tests (ScheduleGrid)
    runs-on: ubuntu-latest
    needs: [frontend-tests, functions-tests]

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: ğŸ”§ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ”¥ Start Firebase Emulators
      run: |
        firebase emulators:start --only firestore,auth &
        sleep 30

    - name: ğŸ§ª Run ScheduleGrid Integration Tests
      working-directory: ./frontend
      run: |
        npm run test:emu -- src/components/__tests__/ScheduleGridCell.test.ts
        npm run test:emu -- src/views/__tests__/ScheduleGridView.test.ts
      env:
        VITE_FIRESTORE_EMULATE: true
        VITE_ENABLE_FIREBASE_EMULATOR: true

  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: ğŸ” Frontend Security Audit
      working-directory: ./frontend
      run: npm audit --audit-level=high

    - name: ğŸ” Functions Security Audit
      working-directory: ./functions
      run: npm audit --audit-level=high

  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: [frontend-tests]

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ—ï¸ Build for Performance Analysis
      working-directory: ./frontend
      run: npm run build:analyze

    - name: âš¡ Bundle Size Check
      working-directory: ./frontend
      run: |
        echo "ğŸ“¦ Bundle Analysis:"
        ls -la dist/assets/
        echo "ğŸ¯ Main bundle should be < 500KB gzipped"

  notify-success:
    name: ğŸ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [frontend-tests, functions-tests, e2e-tests, integration-tests, security-audit, performance-check]
    if: success()

    steps:
    - name: ğŸ‰ All Tests Passed
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo "âœ… Frontend Tests"
        echo "âœ… Functions Tests"
        echo "âœ… E2E Tests"
        echo "âœ… Integration Tests"
        echo "âœ… Security Audit"
        echo "âœ… Performance Check"
        echo "ğŸš€ Ready for deployment!"

  notify-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [frontend-tests, functions-tests, e2e-tests, integration-tests, security-audit, performance-check]
    if: failure()

    steps:
    - name: ğŸš¨ Tests Failed
      run: |
        echo "ğŸš¨ CI checks failed. Please check the logs above."
        echo "ğŸ“‹ Failed jobs will be indicated in the workflow summary."
        exit 1