name: ğŸ¥ Daily Health Check

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“ 9:00 (UTC 0:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          functions/package-lock.json
    
    - name: ğŸŒ Check website accessibility
      run: |
        echo "ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯..."
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID ã‚’å–å¾—ï¼ˆfirebase.json ã‹ã‚‰ï¼‰
        PROJECT_ID=$(grep -o '"projectId": "[^"]*' firebase.json | cut -d'"' -f4)
        echo "ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_ID"
        
        # ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç¢ºèª
        SITE_URL="https://${PROJECT_ID}.web.app"
        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
        
        if [ "$STATUS_CODE" = "200" ]; then
          echo "âœ… ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆæ­£å¸¸ ($SITE_URL)"
          echo "SITE_STATUS=âœ… æ­£å¸¸" >> $GITHUB_ENV
        else
          echo "âŒ ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚¨ãƒ©ãƒ¼ ($SITE_URL) - HTTP: $STATUS_CODE"
          echo "SITE_STATUS=âŒ ã‚¨ãƒ©ãƒ¼ (HTTP: $STATUS_CODE)" >> $GITHUB_ENV
          echo "HAS_ERROR=true" >> $GITHUB_ENV
        fi
    
    - name: ğŸ”’ Security vulnerability check
      run: |
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯..."
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³..."
        cd frontend
        FRONTEND_AUDIT=$(npm audit --audit-level moderate --json 2>/dev/null || echo '{"vulnerabilities":{}}')
        FRONTEND_VULNS=$(echo "$FRONTEND_AUDIT" | jq '.metadata.vulnerabilities.total // 0')
        
        if [ "$FRONTEND_VULNS" -eq 0 ]; then
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: è„†å¼±æ€§ãªã—"
          echo "FRONTEND_SECURITY=âœ… å®‰å…¨" >> $GITHUB_ENV
        else
          echo "âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: $FRONTEND_VULNS ä»¶ã®è„†å¼±æ€§"
          echo "FRONTEND_SECURITY=âš ï¸ $FRONTEND_VULNS ä»¶ã®è„†å¼±æ€§" >> $GITHUB_ENV
          echo "HAS_WARNING=true" >> $GITHUB_ENV
        fi
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        echo "âš¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³..."
        cd ../functions
        BACKEND_AUDIT=$(npm audit --audit-level moderate --json 2>/dev/null || echo '{"vulnerabilities":{}}')
        BACKEND_VULNS=$(echo "$BACKEND_AUDIT" | jq '.metadata.vulnerabilities.total // 0')
        
        if [ "$BACKEND_VULNS" -eq 0 ]; then
          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: è„†å¼±æ€§ãªã—"
          echo "BACKEND_SECURITY=âœ… å®‰å…¨" >> $GITHUB_ENV
        else
          echo "âš ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: $BACKEND_VULNS ä»¶ã®è„†å¼±æ€§"
          echo "BACKEND_SECURITY=âš ï¸ $BACKEND_VULNS ä»¶ã®è„†å¼±æ€§" >> $GITHUB_ENV
          echo "HAS_WARNING=true" >> $GITHUB_ENV
        fi
        
        cd ..
    
    - name: ğŸ“ File structure verification
      run: |
        echo "ğŸ“ é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒã‚§ãƒƒã‚¯..."
        
        REQUIRED_FILES=(
          "frontend/package.json"
          "functions/package.json"
          "firestore.rules"
          "firestore.indexes.json"
          "firebase.json"
        )
        
        MISSING_FILES=""
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            MISSING_FILES="$MISSING_FILES $file"
            echo "HAS_ERROR=true" >> $GITHUB_ENV
          fi
        done
        
        if [ -z "$MISSING_FILES" ]; then
          echo "FILE_STRUCTURE=âœ… æ­£å¸¸" >> $GITHUB_ENV
        else
          echo "FILE_STRUCTURE=âŒ ä¸è¶³:$MISSING_FILES" >> $GITHUB_ENV
        fi
    
    - name: ğŸ“Š Generate health report
      run: |
        echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."
        
        # æ—¥ä»˜å–å¾—
        REPORT_DATE=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        # å…¨ä½“çš„ãªå¥åº·çŠ¶æ…‹åˆ¤å®š
        OVERALL_STATUS="âœ… æ­£å¸¸"
        if [ "${HAS_ERROR:-false}" = "true" ]; then
          OVERALL_STATUS="âŒ è¦å¯¾å¿œ"
        elif [ "${HAS_WARNING:-false}" = "true" ]; then
          OVERALL_STATUS="âš ï¸ ç›£è¦–ç¶™ç¶š"
        fi
        
        # ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        cat > daily-health-report.md << EOF
        # ğŸ¥ Omniy Daily Health Report
        
        **æ—¥æ™‚**: $REPORT_DATE  
        **å…¨ä½“çŠ¶æ³**: $OVERALL_STATUS
        
        ## ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
        
        | é …ç›® | çŠ¶æ³ |
        |------|------|
        | ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ | ${SITE_STATUS:-æœªç¢ºèª} |
        | ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€  | ${FILE_STRUCTURE:-æœªç¢ºèª} |
        | ğŸ”’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | ${FRONTEND_SECURITY:-æœªç¢ºèª} |
        | ğŸ”’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | ${BACKEND_SECURITY:-æœªç¢ºèª} |
        
        ## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        
        $(if [ "${HAS_ERROR:-false}" = "true" ]; then
          echo "ğŸš¨ **ç·Šæ€¥å¯¾å¿œãŒå¿…è¦**"
          echo "- Firebase Console ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª"
          echo "- ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°å¾©æ—§"
          echo "- ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã®åŸå› èª¿æŸ»"
        elif [ "${HAS_WARNING:-false}" = "true" ]; then
          echo "âš ï¸ **è¦ç›£è¦–**"
          echo "- è„†å¼±æ€§ã®è©³ç´°ç¢ºèª"
          echo "- ä»Šæ—¥ä¸­ã®å¯¾å¿œã‚’æ¤œè¨"
          echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå®Ÿè¡Œ"
        else
          echo "âœ… **å•é¡Œãªã—**"
          echo "- é€šå¸¸é‹ç”¨ç¶™ç¶š"
          echo "- å®šæœŸçš„ãªç›£è¦–ç¶™ç¶š"
        fi)
        
        ## ğŸ”— ä¾¿åˆ©ãƒªãƒ³ã‚¯
        
        - [Firebase Console](https://console.firebase.google.com/project/$PROJECT_ID)
        - [ã‚¢ãƒ—ãƒªURL](https://$PROJECT_ID.web.app)
        - [GitHub Actions](https://github.com/${{ github.repository }}/actions)
        
        ---
        *è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ by GitHub Actions*
        EOF
        
        echo "OVERALL_STATUS=$OVERALL_STATUS" >> $GITHUB_ENV
        
        # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’è¡¨ç¤º
        cat daily-health-report.md
    
    - name: ğŸ“§ Send notification (Discord)
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "ğŸ¥ Omniy Daily Health Check"
        description: |
          **å…¨ä½“çŠ¶æ³**: ${{ env.OVERALL_STATUS }}
          
          **è©³ç´°**:
          ğŸŒ ã‚µã‚¤ãƒˆ: ${{ env.SITE_STATUS }}
          ğŸ“ æ§‹é€ : ${{ env.FILE_STRUCTURE }}
          ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ env.FRONTEND_SECURITY }} / ${{ env.BACKEND_SECURITY }}
          
          [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        color: |
          ${{ 
            env.HAS_ERROR == 'true' && 0xFF0000 ||
            env.HAS_WARNING == 'true' && 0xFFA500 ||
            0x00FF00
          }}
    
    - name: ğŸ“§ Send email notification (Critical only)
      if: env.HAS_ERROR == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ Omniy Critical Issue Detected"
        to: ${{ secrets.ALERT_EMAIL }}
        from: "Omniy Monitor <${{ secrets.EMAIL_USERNAME }}>"
        body: |
          Omniyã«é‡è¦ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
          
          å…¨ä½“çŠ¶æ³: ${{ env.OVERALL_STATUS }}
          
          è©³ç´°:
          - ã‚µã‚¤ãƒˆçŠ¶æ³: ${{ env.SITE_STATUS }}
          - ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ : ${{ env.FILE_STRUCTURE }}
          
          æ—©æ€¥ãªç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
          
          è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    - name: ğŸ“„ Upload health report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-health-report-${{ github.run_number }}
        path: daily-health-report.md
        retention-days: 30