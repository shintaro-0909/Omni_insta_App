name: Claude Safe Response

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-safe:
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude')
    
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
      
    steps:
      - name: Extract request
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            BODY="${{ github.event.comment.body }}"
          else
            BODY="${{ github.event.issue.body }}"
          fi
          
          # Extract text after @claude
          REQUEST=$(echo "$BODY" | sed -n 's/.*@claude\s*\(.*\)/\1/p' | head -1)
          echo "request=$REQUEST" >> $GITHUB_OUTPUT
          echo "Request extracted: $REQUEST"
      
      - name: Analyze CI/CD issue
        if: contains(steps.extract.outputs.request, 'CI/CD') || contains(steps.extract.outputs.request, 'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³')
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            // CI/CD analysis response
            const response = `ğŸ¤– **Claude CI/CDåˆ†æãƒ¬ãƒãƒ¼ãƒˆ**
            
            ## ğŸ” åˆ†æçµæœ
            
            ç¾åœ¨ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—ã®ä¸»ãªåŸå› ï¼š
            
            ### 1. **ESLintè¨­å®šã‚¨ãƒ©ãƒ¼**
            - \`frontend/.eslintrc.cjs\`ã®è¨­å®šå•é¡Œ
            - ä¾å­˜é–¢ä¿‚ã®ä¸æ•´åˆ
            
            ### 2. **TypeScriptè¨­å®šå•é¡Œ**  
            - \`tsconfig.json\`ã®è¨­å®šä¸å‚™
            - å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¬ è½
            
            ### 3. **ãƒ†ã‚¹ãƒˆè¨­å®šå•é¡Œ**
            - Jest/Vitestè¨­å®šã®ç«¶åˆ
            - ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸æ•´åˆ
            
            ## ğŸ› ï¸ æ¨å¥¨è§£æ±ºç­–
            
            ### å³åº§ã«å®Ÿè¡Œã™ã¹ãã‚³ãƒãƒ³ãƒ‰:
            \`\`\`bash
            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£
            cd frontend
            npm ci
            npm run lint --fix
            npm run type-check
            
            # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¿®æ­£  
            cd ../functions
            npm ci
            npm run lint --fix
            npm run build
            \`\`\`
            
            ### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:
            1. \`frontend/.eslintrc.cjs\` - ESLintè¨­å®š
            2. \`frontend/tsconfig.json\` - TypeScriptè¨­å®š
            3. \`functions/jest.config.js\` - ãƒ†ã‚¹ãƒˆè¨­å®š
            
            ## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            1. **ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¿®æ­£ç¢ºèª**å¾Œã«ã‚³ãƒŸãƒƒãƒˆ
            2. **GitHub Actionså†å®Ÿè¡Œ**ã§ç¢ºèª
            3. **è¿½åŠ ã®ã‚¨ãƒ©ãƒ¼**ãŒã‚ã‚Œã°å†åº¦@claudeã§ç›¸è«‡
            
            ---
            *Generated with Claude Safe Response v1.0*`;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: response
            });
      
      - name: Generic Claude response
        if: "!contains(steps.extract.outputs.request, 'CI/CD') && !contains(steps.extract.outputs.request, 'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³')"
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            const response = `ğŸ¤– **Claude ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
            
            âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸ: "${context.payload.comment?.body || context.payload.issue?.body}"
            
            **å‡¦ç†å†…å®¹:**
            - åŸºæœ¬çš„ãªåˆ†æã¨å¿œç­”ã‚’æä¾›
            - è¤‡é›‘ãªä½œæ¥­ã¯åˆ¶é™äº‹é …ã«ã‚ˆã‚Šå®Ÿè¡Œä¸å¯
            - è©³ç´°ãªæŠ€è¡“ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®Claude Codeã‚’ã”åˆ©ç”¨ãã ã•ã„
            
            **ãƒ­ãƒ¼ã‚«ãƒ«Claude Codeä½¿ç”¨æ–¹æ³•:**
            \`\`\`bash
            ./scripts/start-claude.sh
            \`\`\`
            
            ---
            *Claude Safe Response - Limited GitHub Actionsç‰ˆ*`;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: response
            });